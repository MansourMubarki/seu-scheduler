{% extends "base.html" %}
{% block content %}

<div class="grid grid-3 no-print">
  <div class="card">
    <h3 style="margin-top:0">إحصائيات سريعة</h3>
    <div class="legend" style="margin:10px 0 14px">
      <span><span class="dot dot-onsite"></span>حضوري</span>
      <span><span class="dot dot-online"></span>عن بعد</span>
      <span><span class="dot dot-exam"></span>اختبارات</span>
    </div>
    <div style="height:200px">
      <canvas id="doughnut"></canvas>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-top:0">حسب اليوم</h3>
    <div style="height:200px">
      <canvas id="byday"></canvas>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-top:0">إجمالي الساعات</h3>
    <p style="font-size:2rem;margin:6px 0"><strong>{{ total_hours }}</strong> ساعة</p>
    <p>المحاضرات: {{ lec_count }} | الاختبارات: {{ exam_count }} (ميد: {{ mid_count }} / فاينل: {{ final_count }})</p>
    <a class="btn" href="{{ url_for('admin_dashboard') }}" {% if not user.is_admin %}style="pointer-events:none;opacity:.5"{% endif %}>لوحة المشرف</a>
  </div>
</div>

<div class="grid grid-2 no-print">
  <div class="card">
    <h3 style="margin-top:0">إضافة محاضرة</h3>
    <form method="post" action="{{ url_for('add_course') }}">
      <div class="grid grid-2">
        <div class="field"><label>العنوان</label><input name="title" required></div>
        <div class="field"><label>اليوم</label>
          <select name="day" required>
            {% for d in ['الأحد','الإثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'] %}
              <option value="{{ d }}">{{ d }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="field"><label>من</label><input name="start" type="time" required></div>
        <div class="field"><label>إلى</label><input name="end" type="time" required></div>
        <div class="field"><label>النمط</label>
          <select name="mode">
            <option>حضوري</option>
            <option>عن بعد</option>
          </select>
        </div>
      </div>
      <button class="btn">إضافة</button>
    </form>
  </div>
  <div class="card">
    <h3 style="margin-top:0">إضافة اختبار</h3>
    <form method="post" action="{{ url_for('add_exam') }}">
      <div class="grid grid-2">
        <div class="field"><label>المقرر</label><input name="title" required></div>
        <div class="field"><label>النوع</label>
          <select name="kind">
            <option>ميد</option><option>فاينل</option>
          </select>
        </div>
        <div class="field"><label>التاريخ</label><input name="date" type="date" required></div>
        <div class="field"><label>من</label><input name="start" type="time" required></div>
        <div class="field"><label>إلى</label><input name="end" type="time" required></div>
      </div>
      <button class="btn">إضافة</button>
    </form>
  </div>
</div>

<div class="card">
  <div class="no-print" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <h3 style="margin:0">جدولي</h3>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="printTable()">طباعة الجدول</button>
    </div>
  </div>

  <div class="print-area">
    <table class="table" id="schedule-table">
      <thead>
        <tr>
          <th>النوع</th>
          <th>العنوان</th>
          <th>اليوم/التاريخ</th>
          <th>الوقت</th>
          <th class="no-print">إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for c in courses %}
        <tr class="tr">
          <td><span class="row-badge badge-{{ 'onsite' if c.mode.strip()=='حضوري' else 'online' }}">محاضرة</span></td>
          <td>{{ c.title }}</td>
          <td>{{ c.day }}</td>
          <td>{{ c.start|to12 }} - {{ c.end|to12 }}</td>
          <td class="no-print">
            <form method="post" action="{{ url_for('delete_course', cid=c.id) }}" onsubmit="return confirm('حذف المحاضرة؟')"><button class="btn btn-outline">حذف</button></form>
          </td>
        </tr>
        {% endfor %}
        {% for e in exams %}
        <tr class="tr">
          <td><span class="row-badge badge-exam">اختبار {{ e.kind }}</span></td>
          <td>{{ e.title }}</td>
          <td>{{ e.date|date_ar }}</td>
          <td>{{ e.start|to12 }} - {{ e.end|to12 }}</td>
          <td class="no-print">
            <form method="post" action="{{ url_for('delete_exam', eid=e.id) }}" onsubmit="return confirm('حذف الاختبار؟')"><button class="btn btn-outline">حذف</button></form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  makeCharts({
    onsite_count: {{ onsite_count }},
    online_count: {{ online_count }},
    exam_count: {{ exam_count }},
    days_ar: {{ days_ar|tojson }},
    counts_by_day: {{ counts_by_day|tojson }},
  });
</script>

{% endblock %}
